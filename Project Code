// Include the necessary libraries
#include <Wire.h>
#include <WiFiClient.h>
#include <BlynkSimpleEsp32.h>

// Blynk template information and Auth Token
#define BLYNK_TEMPLATE_NAME "Plant Watering system"
#define BLYNK_AUTH_TOKEN "1f1erw3fQdB6W6HDGs72q6YvkygueFE7"

// Define sensor and relay pins
#define sensor 33
#define relay 4

// WiFi credentials
char auth[] = BLYNK_AUTH_TOKEN;
char ssid[] = "TP-Link_2988";
char pass[] = "28078005";

// Blynk timer
BlynkTimer timer;

void setup() {
  // Start Serial Monitor
  Serial.begin(115200);

  // Start Blynk
  Blynk.begin(auth, ssid, pass, "blynk.cloud", 80);

  // Setup relay pin
  pinMode(relay, OUTPUT);
  digitalWrite(relay, HIGH); // Motor OFF initially
}

// Function to read soil moisture and send it to Blynk
void soilMoisture() {
  int value = analogRead(sensor);
  value = map(value, 0, 4095, 0, 100);
  value = (value - 100) * -1; // Invert the value

  Blynk.virtualWrite(V0, value); // Send to Blynk app
  Serial.println(value); // Debug print
}

// Function triggered when the Blynk app button is pressed
BLYNK_WRITE(V1) {
  bool Relay = param.asInt();
  if (Relay == 1) {
    digitalWrite(relay, LOW); // Motor ON
    Serial.println("Motor is ON");
  } else {
    digitalWrite(relay, HIGH); // Motor OFF
    Serial.println("Motor is OFF");
  }
}

void loop() {
  soilMoisture(); // Check and send soil moisture
  Blynk.run();    // Run the Blynk service
  delay(200);     // Delay between readings
}
